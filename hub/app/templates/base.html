<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}WWC 2025 – Lab Hub{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121826;
      --text: #e6edf3;
      --muted: #9aa4b2;
      --border: #263042;
      --accent: #8ab4f8;
      --danger: #f87171;
      --success: #4ade80;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(11,15,20,0.9);
    }

    header .title {
      display: flex;
      align-items: baseline;
      gap: 10px;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
    }

    header .tagline {
      margin: 8px 0 0 0;
      color: var(--muted);
      max-width: 980px;
      line-height: 1.4;
    }

    main {
      padding: 24px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .flash {
      margin-bottom: 18px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
    }

    .flash.success { border-color: var(--success); color: var(--success); }
    .flash.error { border-color: var(--danger); color: var(--danger); }

    .controls {
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    button, .btn {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      line-height: 1;
    }

    button:hover, .btn:hover { border-color: var(--accent); }

    button:disabled, .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .btn-danger, button.btn-danger { border-color: var(--danger); color: var(--danger); }
    .btn-primary, button.btn-primary { border-color: var(--accent); color: var(--accent); }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 18px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card h2 { margin: 0; font-size: 18px; }
    .card p { margin: 0; color: var(--muted); line-height: 1.4; }

    .card-actions {
      margin-top: auto;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    a.link {
      color: var(--accent);
      font-size: 14px;
      text-decoration: none;
    }
    a.link:hover { text-decoration: underline; }

    footer {
      margin-top: 36px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 13px;
    }

    code {
      background: rgba(154,164,178,0.12);
      padding: 2px 6px;
      border-radius: 6px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 1000;
    }

    .modal {
      width: 100%;
      max-width: 720px;
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.45);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 16px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .modal-body {
      padding-top: 12px;
    }

    .steps {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 14px;
      color: var(--muted);
    }

    .step {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(154,164,178,0.08);
      color: var(--text);
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .step.ok { border-color: rgba(74,222,128,0.5); }
    .step.err { border-color: rgba(248,113,113,0.6); color: var(--danger); }

    .modal-footer {
      padding-top: 12px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .spinner {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(154,164,178,0.35);
      border-top-color: var(--accent);
      display: inline-block;
      animation: spin 0.9s linear infinite;
      vertical-align: -1px;
      flex: 0 0 auto;
      margin-top: 3px;
    }

    .spinner-lg {
      width: 14px;
      height: 14px;
      border-width: 2px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  {% block head %}{% endblock %}
</head>

<body>

<header>
  <div class="title">
    <h1>{% block header_title %}WWC 2025 – Lab Hub{% endblock %}</h1>
  </div>

  <p class="tagline">
    {% block header_tagline %}
      Start one lab at a time. Starting a new lab automatically stops any other running labs.
    {% endblock %}
  </p>
</header>

<main>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% block content %}{% endblock %}

  <footer>
    {% block footer %}
      Tip: Click <code>Start &amp; Launch</code> and project the opened lab tab for the class.
    {% endblock %}
  </footer>

</main>

<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">
        <span id="modalTitleSpinner" class="spinner spinner-lg" style="display:none;"></span>
        <span id="modalTitleText">Working…</span>
      </h3>
      <button id="modalCloseBtn" class="btn" type="button" disabled>Close</button>
    </div>
    <div class="modal-body">
      <ul id="modalSteps" class="steps"></ul>
    </div>
    <div class="modal-footer">
      <a id="modalLaunchLink" class="btn btn-primary" href="#" target="_blank" rel="noopener" style="display:none;">
        Launch
      </a>
    </div>
  </div>
</div>

<script>
  (function () {
    const backdrop = document.getElementById("modalBackdrop");
    const titleTextEl = document.getElementById("modalTitleText");
    const titleSpinnerEl = document.getElementById("modalTitleSpinner");
    const stepsEl = document.getElementById("modalSteps");
    const closeBtn = document.getElementById("modalCloseBtn");
    const launchLink = document.getElementById("modalLaunchLink");

    let es = null;
    let autoLaunch = false;
    let inProgress = false;

    function showModal(title) {
      titleTextEl.textContent = title || "Working…";
      stepsEl.innerHTML = "";
      launchLink.style.display = "none";
      launchLink.href = "#";

      inProgress = true;
      closeBtn.disabled = true;
      closeBtn.textContent = "Close";
      titleSpinnerEl.style.display = "inline-block";

      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden", "false");

      // Single placeholder that gets removed when first real step arrives
      addStep("Working…", "spin", true);
    }

    function setDoneState() {
      inProgress = false;
      titleSpinnerEl.style.display = "none";
      closeBtn.disabled = false;
      closeBtn.textContent = "Close";
    }

    function hideModal() {
      if (es) {
        es.close();
        es = null;
      }
      autoLaunch = false;
      inProgress = false;
      titleSpinnerEl.style.display = "none";
      closeBtn.disabled = true;
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden", "true");
    }

    function addStep(msg, kind, isPlaceholder) {
      const li = document.createElement("li");
      li.className = "step";
      if (kind === "ok") li.classList.add("ok");
      if (kind === "err") li.classList.add("err");
      if (isPlaceholder) li.dataset.placeholder = "1";

      if (kind === "spin") {
        const sp = document.createElement("span");
        sp.className = "spinner";
        li.appendChild(sp);
      } else {
        const spacer = document.createElement("span");
        spacer.style.width = "12px";
        spacer.style.height = "12px";
        spacer.style.display = "inline-block";
        spacer.style.flex = "0 0 auto";
        spacer.style.marginTop = "3px";
        li.appendChild(spacer);
      }

      const text = document.createElement("div");
      text.innerHTML = escapeHtml(msg);
      li.appendChild(text);

      stepsEl.appendChild(li);
      li.scrollIntoView({ block: "nearest" });
      return li;
    }

    function removePlaceholderIfPresent() {
      const ph = stepsEl.querySelector('[data-placeholder="1"]');
      if (ph) ph.remove();
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function runSSE(url, opts) {
      autoLaunch = !!(opts && opts.autoLaunch);
      es = new EventSource(url);

      es.onmessage = (evt) => {
        let data = null;
        try { data = JSON.parse(evt.data); } catch (e) { return; }

        if (data.type === "step") {
          removePlaceholderIfPresent();
          addStep(data.message, "ok");
          return;
        }

        if (data.type === "error") {
          removePlaceholderIfPresent();
          addStep(data.message, "err");
          setDoneState();
          if (es) { es.close(); es = null; }
          return;
        }

        if (data.type === "done") {
          removePlaceholderIfPresent();
          addStep(data.message || "Done.", "ok");

          const finalLaunchUrl = data.launch_url || null;
          if (finalLaunchUrl) {
            launchLink.href = finalLaunchUrl;
            launchLink.style.display = "inline-block";
          }

          setDoneState();
          if (es) { es.close(); es = null; }

          // Auto-launch only after backend readiness via 'done'
          if (autoLaunch && finalLaunchUrl) {
            window.open(finalLaunchUrl, "_blank", "noopener");
          }
          return;
        }
      };

      es.onerror = () => {
        removePlaceholderIfPresent();
        addStep("Connection error while streaming progress. Check the hub logs.", "err");
        setDoneState();
        if (es) { es.close(); es = null; }
      };
    }

    window.WWCHub = {
      startLab: function (labId, title, shouldAutoLaunch) {
        showModal(title || "Starting lab…");
        runSSE("/api/labs/start/" + encodeURIComponent(labId), { autoLaunch: !!shouldAutoLaunch });
      },
      stopAllLabs: function () {
        showModal("Stopping all labs…");
        runSSE("/api/labs/stop-all", { autoLaunch: false });
      }
    };

    closeBtn.addEventListener("click", () => {
      if (inProgress) return;
      hideModal();
      // Refresh so RUNNING indicator updates without forcing the user to click elsewhere
      window.location.reload();
    });

    backdrop.addEventListener("click", (e) => {
      if (inProgress) return;
      if (e.target === backdrop) {
        hideModal();
        window.location.reload();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && backdrop.style.display === "flex") {
        if (inProgress) return;
        hideModal();
        window.location.reload();
      }
    });
  })();
</script>

</body>
</html>
